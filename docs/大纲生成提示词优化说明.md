# 大纲生成提示词优化说明

## 优化概述

本次优化对`generate_story_outline`方法中的提示词进行了全面改进，融合了用户提供的专业提示词示例，使大纲生成更加结构化、完整和专业。

## 第二次优化（2025-01-10）

### 新增结构化提示词框架

基于用户提供的新例子，进一步优化了提示词结构，采用了更加专业的框架：

**新增框架元素：**
- **Role**: 明确定义AI角色为"才华横溢的网络小说作家"
- **Background And Goals**: 详细描述创作背景和目标
- **Inputs**: 明确输入信息的结构
- **Outputs**: 固定的输出格式说明
- **Workflows**: 详细的7步工作流程
- **init**: 初始化指令

### 优化后的系统提示词结构

```
# Role:
您是一位才华横溢的网络小说作家，因打破常规，用不同寻常的剧情和创意著称。

## Background And Goals:
您正站在创作一部小说的起点，目标是创作一部结构完整、剧情引人深思、设定独树一帜的作品。

## Workflows:
1. 深入挖掘创意火花
2. 魅力四射的开场
3. 精心设计的高潮环节
4. 反转与惊奇的艺术
5. 富有深意的结局
6. 保持创意的新鲜感
7. 输出精细化的小说大纲
```

### 优化后的用户提示词结构

```
## Inputs:
- 情节设定
- 人物列表
- 章节数量

## Outputs:
- 固定的JSON格式
- 详细的结构说明

## init:
- 完整的初始化指令
- 明确的创作要求
```

### 主要改进点

1. **角色定位更加明确**：从"经验丰富的小说家"提升为"才华横溢的网络小说作家"
2. **工作流程更加详细**：新增7步专业工作流程
3. **创意要求更加突出**：强调"打破常规"和"不同寻常的剧情"
4. **结构更加清晰**：采用markdown格式，层次分明
5. **质量要求更加严格**：新增创意新鲜感和反转惊奇元素的要求

## 主要优化内容

### 1. 系统提示词优化

**原始版本：**
```
你是一位专业的小说结构师，专门为奇幻小说创建详细的故事大纲。
```

**优化版本：**
```
你是一位经验丰富的小说家和金牌编剧。你擅长将零散的想法构筑成一个结构完整、情节丰富、引人入胜的精彩故事。你的任务是根据我提供的信息，为我创作一份完整且详细的小说大纲，这份大纲将作为我未来写作的蓝图。

你具有以下专业能力：
- 深厚的故事结构理论知识
- 丰富的人物塑造经验
- 敏锐的情节安排能力
- 对读者心理的深刻理解
```

**优化要点：**
- 明确了AI的角色定位（小说家+编剧）
- 强调了任务目标（完整详细的大纲）
- 列出了具体的专业能力
- 增强了角色扮演的专业性

### 2. 用户提示词结构优化

**新增的结构化要求：**

#### 故事完整性要求
- 大纲必须讲述一个从开端到结局的完整故事
- 清晰地呈现主角的成长弧光和变化历程
- 解决所有核心的矛盾与冲突
- 确保故事逻辑连贯，情节发展自然

#### 分段式结构要求
明确定义了四个主要部分：
1. 开端 (Introduction/Beginning)
2. 发展 (Rising Action/Development) - 可细分为多个阶段
3. 高潮 (Climax)
4. 结局 (Falling Action & Resolution/Ending)

#### 章节分配要求
提供了具体的章节分配建议：
- 开端部分：15-25%
- 发展部分：50-65%
- 高潮部分：10-20%
- 结局部分：10-15%

#### 剧情梗概要求
详细规定了每个部分的梗概必须包含：
- 核心情节和主要事件
- 重要转折点和关键冲突
- 人物关系的变化和发展
- 主角的成长轨迹和心理变化
- 与前后部分的逻辑衔接

#### 具体内容要求
针对每个部分的具体要求：
- 开端部分：详细介绍主角初始状态、背景设定、核心冲突的引入
- 发展部分：展现冲突的不断升级和故事的层层递进
- 高潮部分：描述最激烈的冲突和关键转折
- 结局部分：提供明确完整的结局，解决所有主要问题

### 3. JSON格式增强

**新增的JSON字段：**
- `conflict_type`: 主要冲突类型（内在冲突/外在冲突/人际冲突等）
- `story_function`: 这个部分在整个故事中的功能作用

**原有字段保留：**
- `part`: 部分名称
- `chapters`: 章节范围
- `chapter_numbers`: 章节数字数组
- `summary`: 详细剧情梗概
- `key_events`: 关键事件列表
- `character_development`: 角色发展变化
- `connection`: 与前后部分的衔接关系

### 4. 质量保证要求

**新增的质量检查项：**
- 所有章节都被分配到某个部分，不能遗漏
- 各部分之间有良好的逻辑衔接和过渡
- 故事结构符合经典的起承转合模式
- 每个部分的梗概详细且具体，避免空泛描述
- 主角的成长弧光贯穿始终，变化明显
- 所有核心冲突都得到合理解决

## 优化效果预期

### 1. 故事完整性提升
- 确保生成的大纲是一个完整的故事，而不是片段
- 强调主角成长弧光的连贯性
- 所有冲突都得到合理解决

### 2. 结构化程度提升
- 明确的章节分配比例指导
- 详细的分段要求和功能定义
- 更加专业的故事结构理论应用

### 3. 内容质量提升
- 更详细的剧情梗概要求
- 明确的人物发展轨迹
- 清晰的部分间逻辑关系

### 4. 专业性提升
- 角色扮演更加专业和具体
- 借鉴了成熟的编剧理论
- 增强了对读者心理的考虑

## 技术实现细节

### 代码文件
- **修改文件**: `/Volumes/LLM/gpt-story-genius/write_story_enhanced.py`
- **修改方法**: `generate_story_outline`
- **修改行数**: 约271-347行

### 兼容性
- 保持了原有的JSON返回格式
- 新增字段为可选扩展，不影响现有解析逻辑
- 保留了用户自定义系统提示词的支持

### 测试建议
1. 测试不同章节数量的大纲生成（如10章、20章、50章）
2. 验证章节分配的合理性
3. 检查生成的大纲是否符合完整性要求
4. 确认JSON格式的正确性

## 第二次优化效果预期

### 1. 创意质量提升
- **打破常规思维**：强调"才华横溢"和"打破常规"的角色定位
- **增强原创性**：明确要求避免陈词滥调，保持创意新鲜感
- **融入反转元素**：要求设计出人意料又情理之中的剧情反转

### 2. 结构专业化程度提升
- **7步工作流程**：提供详细的创作步骤指导
- **分层式结构**：Role → Background → Workflows → Inputs → Outputs → init
- **初始化指令**：确保AI充分理解任务要求

### 3. 输出质量保证
- **固定格式输出**：明确的JSON格式要求
- **质量检查标准**：8项具体的质量保证要求
- **创意与结构并重**：既要有创意新鲜感，又要有完整的故事结构

### 4. 技术实现
- **代码文件**: `/Volumes/LLM/gpt-story-genius/write_story_enhanced.py`
- **修改方法**: `generate_story_outline`
- **修改行数**: 约271-376行
- **兼容性**: 保持原有JSON返回格式，新增质量要求

## 第三次优化（2025-01-10）

### 修复故事线生成JSON解析问题

基于用户反馈的错误信息，发现故事线生成过程中存在JSON解析失败的问题，导致所有章节内容都一样。进行了以下优化：

**问题分析：**
- 故事线生成API返回的内容格式不一致
- JSON解析失败导致回退到默认内容
- 缺乏有效的响应内容清理机制

**优化方案：**

1. **改进故事线生成提示词**：
   - 重新设计系统提示词，明确要求JSON格式输出
   - 增加详细的格式说明和示例
   - 优化用户内容结构，使用markdown格式增强可读性

2. **新增JSON响应清理功能**：
   - 添加`clean_json_response`方法
   - 智能提取JSON代码块
   - 自动移除前后缀文字干扰
   - 修复常见JSON格式错误

3. **增强错误处理**：
   - 检测并处理用户系统提示词与JSON格式的冲突
   - 改进重试机制和备用内容生成
   - 优化日志输出，便于问题诊断

**修改文件：**
- `/Volumes/LLM/gpt-story-genius/write_story_enhanced.py`
- 新增`clean_json_response`方法（第776-843行）
- 优化`generate_storyline_batch`方法（第845-930行）
- 修复未使用变量的警告

**优化效果：**
- 提高JSON解析成功率
- 确保章节内容的差异化
- 减少故事线生成失败的情况
- 增强系统稳定性和可靠性

## 第四次优化（2025-07-10）

### 优化章节正文生成提示词

针对用户要求优化正文生成提示词，特别是开头和结尾章节的处理，实现了基于章节位置的智能化提示词生成：

**优化目标：**
- 增强第一章的开篇吸引力
- 改善最后两章的结尾处理
- 确保最后一章完美收官，添加"全文完"标记

**主要改进：**

1. **第一章特殊优化**：
   - 新增7项开篇特殊要求
   - 强调引人入胜的开头设计
   - 优化人物和背景介绍方式
   - 增强开头冲击力和悬念设置

2. **章节位置感知系统**：
   - 修改`write_chapter`方法签名，增加`current_chapter_num`和`total_chapters`参数
   - 实现基于章节位置的智能提示词生成
   - 针对不同章节位置提供专门的创作指导

3. **结尾章节优化**：
   - **最后一章**：完美收尾所有情节线，营造满足的结束感
   - **倒数第二章**：推向最终高潮，为大结局做铺垫
   - **前两章**：深入建立世界观，平衡介绍和推进

4. **提示词结构改进**：
   - 为第一章添加7项特殊创作要求
   - 为不同位置章节添加针对性指导
   - 改进章节生成的改进版提示词

**修改文件：**
- `/Volumes/LLM/gpt-story-genius/write_story_enhanced.py`
- 优化`write_first_chapter`方法（第456-494行）
- 改进`write_chapter`方法（第573-660行）
- 更新调用处理，传递章节位置信息（第1252-1264行）

**优化效果：**
- 第一章开篇更具吸引力和冲击力
- 最后两章结尾处理更加完善
- 基于章节位置的智能化创作指导
- 确保故事结构的完整性和连贯性

## 第五次优化（2025-07-10）

### 强化大纲Summary的详细程度

基于用户要求更新大纲提示词，要求每一部分的summary更加详细，为后续章节创作提供更充分的指导：

**优化目标：**
- 大幅提升summary的详细程度和可操作性
- 为后续章节创作提供充分的细节指导
- 确保大纲能够支撑高质量的章节内容生成

**主要改进：**

1. **Summary详细程度要求**：
   - 明确要求每个部分的summary至少300-500字
   - 必须包含具体场景、对话要点、行动细节
   - 详细描述人物心理变化和成长轨迹

2. **Summary内容结构优化**：
   - **核心情节和主要事件**：具体场景、对话要点、行动细节
   - **重要转折点和关键冲突**：具体情况、性质、原因、后果
   - **人物关系变化**：情感变化、立场转换、联盟与对立
   - **主角成长轨迹**：内心世界、价值观变化、能力提升
   - **场景环境描述**：地点、时间、环境氛围
   - **次要角色作用**：配角的具体贡献和发展
   - **伏笔悬念设置**：为后续情节的铺垫和悬念点

3. **各部分Summary专项要求**：
   - **开端部分**：主角初始状态、世界背景、冲突引入过程、角色登场、基调确立
   - **发展部分**：冲突升级、能力提升、新角色、关键挑战、关系复杂化、世界观展开
   - **高潮部分**：激烈冲突、关键转折、最大考验、铺垫汇聚、决定性场面、最终选择
   - **结局部分**：完整结局、问题解决、最终状态、角色去向、新秩序、思考余韵

4. **质量保证强化**：
   - Summary必须可操作，为章节创作提供充分指导
   - 不能只是概括性描述，必须包含具体情节细节
   - 在JSON格式示例中明确标注详细要求
   - 在init部分特别强调summary的核心重要性

**修改文件：**
- `/Volumes/LLM/gpt-story-genius/write_story_enhanced.py`
- 更新剧情梗概要求（第347-356行）
- 强化具体内容要求（第358-362行）
- 优化质量保证要求（第364-374行）
- 改进JSON格式示例（第312行）
- 强化init部分说明（第376-381行）

**优化效果：**
- Summary详细程度大幅提升，从简单概括升级为详细描述
- 为后续章节创作提供充分的细节指导和依据
- 确保大纲质量能够支撑高质量的小说内容生成
- 提高整个创作流程的连贯性和专业性

## 总结

**第一次优化**通过融合专业的编剧理论和用户提供的优质提示词示例，大幅提升了大纲生成的专业性和完整性。

**第二次优化**在此基础上，进一步采用了结构化的提示词框架，强调了创意的新鲜感和反转惊奇的艺术，使AI能够生成更加引人入胜、具有原创性的故事大纲。

**第三次优化**重点解决了故事线生成过程中的JSON解析问题，通过改进提示词设计和增加响应清理功能，确保了故事线生成的稳定性和章节内容的差异化。

**第四次优化**专注于章节正文生成的质量提升，特别是开头和结尾章节的处理。通过实现章节位置感知的智能提示词系统，确保了不同位置章节都能获得最合适的创作指导，从而生成更高质量、更具结构感的小说内容。

**第五次优化**重点强化了大纲Summary的详细程度，将每个部分的summary从简单概括升级为300-500字的详细描述，包含具体场景、对话要点、行动细节等，为后续章节创作提供充分的细节指导和依据。

五次优化的累积效果，使StoryGenius形成了从大纲构思到章节创作的完整优化体系：
- **大纲阶段**：专业化、结构化、富有创意、详细可操作
- **故事线阶段**：稳定可靠、内容差异化、JSON格式完善
- **正文阶段**：位置感知、开头吸引、结尾完善、细节丰富

这确保了系统能够生成既专业又富有创意的高质量长篇小说，整个创作流程从大纲到成文都有充分的细节支撑，为用户提供完整、专业的小说创作解决方案。