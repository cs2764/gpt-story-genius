# StoryGenius 文章生成步骤和API调用详细总结

## 概述

StoryGenius的小说生成过程共包含**10个主要步骤**，每个步骤都涉及向AI API发送特定的提示词和数据，获取结构化的响应。

## 完整生成流程

### **第1步：生成情节候选（Generate Plots）**
**目的**：基于用户输入生成多个情节选项

**发送给AI的数据**：
- **系统提示词**：`"你是一个创意助手，专门生成引人入胜的奇幻小说情节。"`
- **用户内容**：`"基于这个提示生成10个奇幻小说情节：{用户输入的故事描述}"`
- **自定义系统提示**：如果用户设置了自定义提示词，会添加到用户内容前面

**AI返回**：10个不同的情节描述（纯文本）

**后处理**：按换行符分割成列表

---

### **第2步：选择最佳情节（Select Best Plot）**
**目的**：从候选情节中选择或组合出最优情节

**发送给AI的数据**：
- **系统提示词**：`"你是写作奇幻小说情节的专家。"`
- **用户内容**：`"这里有一些可能的小说情节：{第1步生成的所有情节}\n\n现在，写出我们将采用的最终情节。它可以是其中一个，也可以是多个最佳元素的混合，或者是全新且更好的东西。"`

**AI返回**：单个优化后的情节描述

**后处理**：直接使用返回的字符串

---

### **第3步：改进情节（Improve Plot）**
**目的**：进一步完善选定的情节

**发送给AI的数据**：
- **系统提示词**：`"你是改进和完善故事情节的专家。"`
- **用户内容**：`"改进这个情节：{第2步选择的情节}"`

**AI返回**：改进后的情节描述

**后处理**：直接使用返回的字符串

---

### **第4步：生成角色列表（Generate Character List）**
**目的**：为故事创建详细的角色设定

**发送给AI的数据**：
- **系统提示词**：`"你是一位专业的小说角色设计师，专门为奇幻小说创建详细的角色档案。"`
- **用户内容**：
  ```
  基于以下情节为{章节数}章的奇幻小说创建主要人物列表：
  
  情节：{改进后的情节}
  
  请创建详细的人物列表，包含：
  1. 主角（1-2个）
  2. 重要配角（3-5个）
  3. 反派角色（1-2个）
  4. 其他关键角色（根据需要）
  
  每个角色需要包含：
  - 姓名、年龄、性格特点、背景设定
  - 在故事中的作用、能力或特长、外貌特征
  
  请按照JSON格式返回。
  ```

**AI返回**：JSON格式的角色列表

**后处理**：直接保存为字符串（后续使用时再解析JSON）

---

### **第5步：生成故事大纲（Generate Story Outline）**
**目的**：创建整体故事结构框架

**发送给AI的数据**：
- **系统提示词**：`"你是一位专业的小说结构师，专门为奇幻小说创建详细的故事大纲。"`
- **用户内容**：
  ```
  基于以下信息为{章节数}章的奇幻小说创建详细的故事大纲：
  
  情节：{改进后的情节}
  人物列表：{角色列表JSON}
  
  请创建完整的故事大纲，包含：
  1. 开端部分（章节范围和概述）
  2. 发展部分（可分为多个阶段）
  3. 高潮部分（章节范围和概述）
  4. 结尾部分（章节范围和概述）
  
  请按照JSON格式返回。
  ```

**AI返回**：JSON格式的故事大纲

**后处理**：直接保存为字符串

---

### **第6步：生成标题（Generate Title）**
**目的**：为小说创建合适的标题

**发送给AI的数据**：
- **系统提示词**：`"你是一位专业作家。"`
- **用户内容**：`"这是情节：{改进后的情节}\n\n这本书的标题是什么？只回答标题，不要做其他事情。"`

**AI返回**：小说标题

**后处理**：使用`sanitize_filename()`清理特殊字符，确保可用作文件名

---

### **第7步：生成详细故事线（Generate Storyline）**
**目的**：为每个章节创建具体的情节发展

**处理逻辑**：
- **≤10章**：单次API调用处理所有章节
- **>10章**：分批处理，每批10章

**发送给AI的数据**（每批）：
- **系统提示词**：`"你是一位世界级的奇幻小说作家。"`
- **用户内容**：
  ```
  基于以下信息为第{起始章节}-{结束章节}章创建详细的故事线：
  
  情节：{改进后的情节}
  人物列表：{角色列表JSON}
  故事大纲：{故事大纲JSON}
  
  请为每章创建详细的故事线，包含：
  - 具体的情节发展
  - 人物互动和关键事件
  - 章节间的过渡和连贯性
  
  请按照JSON格式返回，格式为章节字典数组。
  ```

**AI返回**：每章故事线的JSON数组

**后处理**：
- 多批次结果合并成单个JSON
- 验证是否包含所有章节
- 如果失败，生成差异化的默认故事线

---

### **第8步：写第一章（Write First Chapter）**
**目的**：创建小说的开篇章节

**两阶段处理**：

**阶段一：初稿生成**
- **系统提示词**：`"你是一位世界级的奇幻小说作家。"`
- **用户内容**：
  ```
  基于以下信息写这部小说的第一章：
  
  情节：{改进后的情节}
  人物列表：{角色列表JSON}
  故事大纲：{故事大纲JSON}
  本章标题：{第一章标题}
  本章故事线：{第一章故事线}
  写作风格：{写作风格说明}
  
  请将章节正文内容包装在<CHAPTER_CONTENT>标记中。
  ```

**阶段二：改进重写**
- **系统提示词**：`"你是一位世界级的奇幻小说作家。你的工作是拿学生的第一章初稿，重写得更好，更详细。"`
- **用户内容**：
  ```
  基于以下信息改进第一章：
  
  学生的第一章初稿：{初稿内容}
  情节：{改进后的情节}
  人物列表：{角色列表JSON}
  故事大纲：{故事大纲JSON}
  本章标题：{第一章标题}
  本章故事线：{第一章故事线}
  
  现在，重写这部小说的第一章，要比学生的版本好得多。
  请将章节正文内容包装在<CHAPTER_CONTENT>标记中。
  ```

**AI返回**：包含在`<CHAPTER_CONTENT>`标签内的章节内容

**后处理**：
- 提取标签内的内容
- 生成章节摘要
- 保存章节文件

---

### **第9步：写后续章节（Write Subsequent Chapters）**
**目的**：基于前文上下文写每个后续章节

**上下文优化策略**：
- **最近1-2章**：使用完整章节内容
- **前面5章**：仅使用章节摘要
- **早期章节（1-3章）**：所有前文都使用完整内容

**发送给AI的数据**：
- **系统提示词**：`"你是一位世界级的奇幻小说作家。"`
- **用户内容**：
  ```
  基于以下信息写这部小说的下一章：
  
  情节：{改进后的情节}
  人物列表：{角色列表JSON}
  故事大纲：{故事大纲JSON}
  前面的章节：{优化后的前文上下文}
  本章标题：{当前章节标题}
  本章故事线：{当前章节故事线}
  接下来5章的预览：{未来章节信息}
  
  请确保：
  1. 人物行为符合角色设定
  2. 情节与前文连贯
  3. 推进故事发展
  4. 包含适当的对话、动作和描写
  
  请将章节正文内容包装在<CHAPTER_CONTENT>标记中。
  ```

**AI返回**：包含在`<CHAPTER_CONTENT>`标签内的章节内容

**后处理**：
- 提取标签内的内容
- 生成章节摘要
- 保存章节和摘要文件
- 更新上下文缓存

---

### **第10步：生成章节摘要（Summarize Chapter）**
**目的**：为每章生成简洁摘要，用于后续上下文管理

**发送给AI的数据**：
- **系统提示词**：`"你是一位专业的文学编辑。"`
- **用户内容**：
  ```
  请为以下小说章节生成一个简洁但全面的摘要：
  
  章节标题：{章节标题}
  章节内容：{完整章节内容}
  
  摘要应该：
  1. 保留关键情节发展
  2. 记录重要人物动向
  3. 保持逻辑连贯性
  4. 长度控制在200-300字之间
  
  请直接返回摘要内容，不需要其他说明。
  ```

**AI返回**：200-300字的章节摘要

**后处理**：
- 直接保存摘要到文件
- 用于后续章节的上下文构建

---

## API调用管理机制

### **核心API函数**
`create_completion_with_monitoring(messages, **kwargs)`

**功能特性**：
- **监控追踪**：记录token使用量、成本、响应时间
- **错误处理**：失败时等待10秒后重试一次
- **多提供商支持**：自动适配不同AI提供商的API格式
- **成本估算**：粗略计算token数量（文本长度÷4）

### **响应格式处理**
`extract_content_from_response(response)`

**支持的提供商格式**：
- **OpenAI**：`response['choices'][0]['message']['content']`
- **Claude**：`response['content'][0]['text']` 或 `response['content']`
- **Gemini**：`response['candidates'][0]['content']['parts'][0]['text']`
- **通用格式**：`response['text']`

**内容清理**：
- 移除`<think>...</think>`思考标签
- 提取`<CHAPTER_CONTENT>`标签内容
- 清理元数据和分析文本

### **错误处理策略**

1. **API调用失败**：等待10秒后重试一次
2. **内容提取失败**：使用智能后备提取方法
3. **JSON解析失败**：使用默认章节结构
4. **Token限制**：通过摘要优化上下文长度

### **性能优化**

1. **上下文管理**：基于摘要的token优化，减少70-90%的token使用
2. **批处理**：故事线生成时多章节合并处理
3. **缓存机制**：提供商模型列表缓存5分钟
4. **监控系统**：实时追踪成本和性能指标

### **数据存储**

- **章节文件**：`story/{novel_id}/chapter_{n}/{chapter_title}.txt`
- **摘要文件**：`story/{novel_id}/chapter_{n}/summary.txt`
- **元数据**：JSON格式的创作信息
- **监控数据**：API调用指标和成本统计

## 总结

整个流程确保了高质量的小说生成，通过10个精心设计的步骤，每个步骤都有明确的API输入输出格式，并配备完善的错误处理和性能优化机制。系统能够生成连贯一致的长篇小说，同时有效管理成本和token使用量。