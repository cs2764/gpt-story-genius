# APIè°ƒç”¨é—®é¢˜ä¿®å¤æŠ¥å‘Š

> **é¡¹ç›®å£°æ˜**  
> æœ¬é¡¹ç›®æ˜¯å¯¹ [https://github.com/Crossme0809/gpt-story-genius](https://github.com/Crossme0809/gpt-story-genius) çš„äºŒæ¬¡å¼€å‘  
> ğŸ¤– æ‰€æœ‰ä»£ç ä»¥åŠæ–‡æ¡£å‡ç”± Claude Code ç”Ÿæˆ

## ğŸ¯ ä¿®å¤çš„é—®é¢˜

### 1. LM Studioæ¨¡å‹é€‰æ‹©ä¸æ­£ç¡®çš„é—®é¢˜

**é—®é¢˜æè¿°ï¼š**
ä½¿ç”¨LM Studioæ—¶ï¼Œè™½ç„¶åœ¨ç•Œé¢ä¸­é€‰æ‹©äº†ç‰¹å®šæ¨¡å‹ï¼Œä½†å®é™…APIè°ƒç”¨æ—¶å¹¶æ²¡æœ‰ä½¿ç”¨æ‰€é€‰çš„æ¨¡å‹ã€‚

**æ ¹æœ¬åŸå› ï¼š**
- `write_fantasy_novel` æ–¹æ³•æ¥æ”¶äº† `model_name` å‚æ•°ï¼Œä½†æ²¡æœ‰å°†å…¶ä¼ é€’ç»™å®é™…çš„APIè°ƒç”¨
- `create_completion_with_monitoring` æ–¹æ³•æ²¡æœ‰è€ƒè™‘ç”¨æˆ·é€‰æ‹©çš„æ¨¡å‹

**ä¿®å¤æ–¹æ¡ˆï¼š**

1. **åœ¨StoryWriterç±»ä¸­æ·»åŠ æ¨¡å‹è·Ÿè¸ªï¼š**
   ```python
   class StoryWriter:
       def __init__(self):
           self.config_manager = EnhancedConfigManager()
           self.total_cost = 0.0
           self.current_model = None  # å­˜å‚¨å½“å‰ä½¿ç”¨çš„æ¨¡å‹
   ```

2. **ä¿®æ”¹create_completion_with_monitoringæ–¹æ³•ï¼š**
   ```python
   def create_completion_with_monitoring(self, messages: List[Dict], **kwargs) -> Dict:
       # å¦‚æœè®¾ç½®äº†å½“å‰æ¨¡å‹ï¼Œä½¿ç”¨å®ƒ
       if self.current_model and 'model' not in kwargs:
           kwargs['model'] = self.current_model
           logger.info(f"ä½¿ç”¨æŒ‡å®šæ¨¡å‹: {self.current_model}")
   ```

3. **åœ¨write_fantasy_novelä¸­è®¾ç½®æ¨¡å‹ï¼š**
   ```python
   def write_fantasy_novel(self, prompt: str, num_chapters: int, writing_style: str, 
                          provider_name: str = None, model_name: str = None):
       # è®¾ç½®å½“å‰ä½¿ç”¨çš„æ¨¡å‹
       if model_name:
           self.current_model = model_name
           logger.info(f"è®¾ç½®ä½¿ç”¨æ¨¡å‹ï¼š{model_name}")
   ```

**ä¿®å¤æ•ˆæœï¼š**
âœ… ç°åœ¨æ‰€æœ‰APIè°ƒç”¨éƒ½ä¼šä½¿ç”¨ç”¨æˆ·åœ¨ç•Œé¢ä¸­é€‰æ‹©çš„å…·ä½“æ¨¡å‹
âœ… å¢åŠ äº†è¯¦ç»†çš„æ—¥å¿—è®°å½•ï¼Œä¾¿äºè°ƒè¯•
âœ… æ”¯æŒåŠ¨æ€æ¨¡å‹åˆ‡æ¢

### 2. OpenRouter API 401é”™è¯¯

**é—®é¢˜æè¿°ï¼š**
ä½¿ç”¨OpenRouteræ—¶å‡ºç°401 Unauthorizedé”™è¯¯ï¼Œå³ä½¿è®¾ç½®äº†APIå¯†é’¥ä¹Ÿæ— æ³•æˆåŠŸè°ƒç”¨ã€‚

**æ ¹æœ¬åŸå› åˆ†æï¼š**
1. **æµ‹è¯•APIå¯†é’¥æ— æ•ˆï¼š** é…ç½®æ–‡ä»¶ä¸­ä½¿ç”¨çš„æ˜¯æµ‹è¯•å¯†é’¥ `sk-test-key-12345678901234567890`
2. **é”™è¯¯å¤„ç†ä¸å‹å¥½ï¼š** åŸæ¥åªæ˜¾ç¤ºHTTPé”™è¯¯ç ï¼Œä¸å‘Šè¯‰ç”¨æˆ·å…·ä½“é—®é¢˜
3. **ç¼ºå°‘APIå¯†é’¥éªŒè¯ï¼š** æ²¡æœ‰åœ¨è°ƒç”¨å‰éªŒè¯APIå¯†é’¥æ ¼å¼

**ä¿®å¤æ–¹æ¡ˆï¼š**

1. **å¢å¼ºAPIå¯†é’¥éªŒè¯ï¼š**
   ```python
   # éªŒè¯APIå¯†é’¥æ ¼å¼
   if not self.config.api_key or len(self.config.api_key) < 10:
       raise ValueError("OpenRouter APIå¯†é’¥æ— æ•ˆã€‚è¯·åœ¨é…ç½®é¡µé¢è®¾ç½®æœ‰æ•ˆçš„APIå¯†é’¥ã€‚")
   ```

2. **æ”¹è¿›è¯·æ±‚headersï¼š**
   ```python
   # è®¾ç½®æ¨èçš„headers
   headers = {
       "Authorization": f"Bearer {self.config.api_key}",
       "Content-Type": "application/json"
   }
   ```

3. **è¯¦ç»†çš„é”™è¯¯å¤„ç†ï¼š**
   ```python
   if response.status_code == 401:
       raise ValueError("OpenRouter APIå¯†é’¥æ— æ•ˆæˆ–å·²è¿‡æœŸã€‚è¯·æ£€æŸ¥æ‚¨çš„APIå¯†é’¥é…ç½®ã€‚")
   elif response.status_code == 402:
       raise ValueError("OpenRouterè´¦æˆ·ä½™é¢ä¸è¶³ã€‚è¯·å……å€¼åé‡è¯•ã€‚")
   elif response.status_code == 429:
       raise ValueError("OpenRouter APIè°ƒç”¨é¢‘ç‡è¿‡é«˜ã€‚è¯·ç¨åé‡è¯•ã€‚")
   ```

**ä¿®å¤æ•ˆæœï¼š**
âœ… æä¾›äº†æ¸…æ™°çš„é”™è¯¯ä¿¡æ¯ï¼Œå‘Šè¯‰ç”¨æˆ·å…·ä½“é—®é¢˜
âœ… åœ¨è°ƒç”¨å‰éªŒè¯APIå¯†é’¥æ ¼å¼ï¼Œé¿å…æ— æ•ˆè¯·æ±‚
âœ… æ”¯æŒä¸åŒHTTPé”™è¯¯ç çš„è¯¦ç»†è¯´æ˜
âœ… æ·»åŠ äº†è¶…æ—¶è®¾ç½®ï¼Œé¿å…é•¿æ—¶é—´ç­‰å¾…

## ğŸ“‹ æµ‹è¯•éªŒè¯

### OpenRouteré”™è¯¯å¤„ç†æµ‹è¯•

æµ‹è¯•äº†ä»¥ä¸‹åœºæ™¯ï¼š
- âœ… ç©ºAPIå¯†é’¥ï¼šæ­£ç¡®æ˜¾ç¤º"APIå¯†é’¥æ— æ•ˆ"
- âœ… çŸ­APIå¯†é’¥ï¼šæ­£ç¡®æ˜¾ç¤º"APIå¯†é’¥æ— æ•ˆ"  
- âœ… æ— æ•ˆAPIå¯†é’¥ï¼šæ­£ç¡®æ˜¾ç¤º"APIå¯†é’¥æ— æ•ˆæˆ–å·²è¿‡æœŸ"

### LM Studioæ¨¡å‹é€‰æ‹©æµ‹è¯•

- âœ… æ¨¡å‹å‚æ•°æ­£ç¡®ä¼ é€’åˆ°APIè°ƒç”¨
- âœ… æ—¥å¿—æ˜¾ç¤ºä½¿ç”¨çš„å…·ä½“æ¨¡å‹åç§°
- âœ… æ”¯æŒåŠ¨æ€æ¨¡å‹åˆ‡æ¢

## ğŸ”§ ç”¨æˆ·æ“ä½œæŒ‡å—

### é…ç½®OpenRouter

1. è·å–æœ‰æ•ˆçš„APIå¯†é’¥ï¼š
   - è®¿é—® https://openrouter.ai/keys
   - åˆ›å»ºæ–°çš„APIå¯†é’¥
   - å¤åˆ¶å®Œæ•´çš„å¯†é’¥ï¼ˆæ ¼å¼ï¼šsk-or-v1-...ï¼‰

2. åœ¨é…ç½®é¡µé¢è®¾ç½®ï¼š
   - è¿›å…¥"âš™ï¸ é…ç½®ç®¡ç†" â†’ "ğŸ”§ AIæä¾›å•†é…ç½®"
   - é€‰æ‹©"OpenRouter"
   - ç²˜è´´APIå¯†é’¥
   - ç‚¹å‡»"ğŸ’¾ ä¿å­˜é…ç½®"
   - ç‚¹å‡»"ğŸ”— æµ‹è¯•è¿æ¥"éªŒè¯

### ä½¿ç”¨LM Studio

1. ç¡®ä¿LM Studioæ­£åœ¨è¿è¡Œï¼š
   - å¯åŠ¨LM Studioåº”ç”¨
   - åŠ è½½ä¸€ä¸ªæ¨¡å‹
   - ç¡®ä¿APIæœåŠ¡å™¨å·²å¯åŠ¨ï¼ˆé€šå¸¸åœ¨ç«¯å£1234ï¼‰

2. åœ¨é…ç½®é¡µé¢è®¾ç½®ï¼š
   - Base URLè®¾ç½®ä¸ºï¼š`http://localhost:1234/v1`
   - APIå¯†é’¥å¯ä»¥ç•™ç©ºæˆ–è®¾ç½®ä»»æ„å€¼
   - æµ‹è¯•è¿æ¥ç¡®ä¿å¯ä»¥è·å–æ¨¡å‹åˆ—è¡¨

3. åœ¨åˆ›ä½œé¡µé¢é€‰æ‹©å…·ä½“æ¨¡å‹ï¼š
   - ä»æ¨¡å‹ä¸‹æ‹‰åˆ—è¡¨ä¸­é€‰æ‹©è¦ä½¿ç”¨çš„æ¨¡å‹
   - ç¡®è®¤é€‰æ‹©çš„æ¨¡å‹ä¸LM Studioä¸­åŠ è½½çš„æ¨¡å‹ä¸€è‡´

## ğŸ›¡ï¸ å®‰å…¨æ”¹è¿›

1. **APIå¯†é’¥ä¿æŠ¤ï¼š**
   - å¢åŠ äº†å¯†é’¥æ ¼å¼éªŒè¯
   - æä¾›äº†è¯¦ç»†çš„é”™è¯¯æç¤º
   - é¿å…åœ¨æ—¥å¿—ä¸­æ³„éœ²å®Œæ•´å¯†é’¥

2. **ç½‘ç»œè¯·æ±‚å®‰å…¨ï¼š**
   - æ·»åŠ äº†è¯·æ±‚è¶…æ—¶è®¾ç½®
   - æ”¹è¿›äº†é”™è¯¯å¤„ç†
   - æ”¯æŒä¸åŒé”™è¯¯åœºæ™¯çš„å¤„ç†

3. **ç”¨æˆ·ä½“éªŒï¼š**
   - æä¾›äº†æ¸…æ™°çš„é”™è¯¯ä¿¡æ¯
   - å¢åŠ äº†é…ç½®éªŒè¯æ­¥éª¤
   - æ”¹å–„äº†è°ƒè¯•èƒ½åŠ›

## ğŸ“ˆ æ€§èƒ½ä¼˜åŒ–

1. **æ¨¡å‹é€‰æ‹©ä¼˜åŒ–ï¼š**
   - é¿å…äº†é‡å¤çš„æ¨¡å‹åˆ‡æ¢
   - å‡å°‘äº†ä¸å¿…è¦çš„APIè°ƒç”¨
   - æ”¹å–„äº†å“åº”æ—¶é—´

2. **é”™è¯¯å¤„ç†ä¼˜åŒ–ï¼š**
   - å¿«é€Ÿå¤±è´¥æœºåˆ¶
   - è¯¦ç»†çš„é”™è¯¯åˆ†ç±»
   - å‡å°‘ç”¨æˆ·ç­‰å¾…æ—¶é—´

è¿™äº›ä¿®å¤ç¡®ä¿äº†AIæä¾›å•†çš„ç¨³å®šæ€§å’Œç”¨æˆ·ä½“éªŒï¼Œç‰¹åˆ«æ˜¯åœ¨ä½¿ç”¨OpenRouterå’ŒLM Studioæ—¶çš„å¯é æ€§ã€‚